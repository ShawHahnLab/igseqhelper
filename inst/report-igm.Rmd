# IgM+ Specimens - Germline allele discovery with IgDiscover

```{r}
SEGMENTS <- c("V", "D", "J")
names(SEGMENTS) <- SEGMENTS

# Specific to how we're running IgDiscover
CHAINTYPES <- c(mu = "heavy.mu", lambda = "light.lambda", kappa = "light.kappa")

# Load nested lists of final results from an IgDiscover output directory.
load_igdiscover_final <- function(dirpath) {
  data <- within(list(), {
    path <- dirpath
    database <- lapply(SEGMENTS, function(segment) {
      dnar::read.fa(
        file.path(dirpath, "final/database", paste0(segment, ".fasta")))
    })
    stats <- list(
      filtered = rjson::fromJSON(file = file.path(dirpath, "final/stats/filtered.json")),
      assigned = rjson::fromJSON(file = file.path(dirpath, "final/stats/assigned.json")))
    clusterplots <- list.files(
      path = file.path(dirpath, "final/clusterplots"),
      full.names = TRUE,
      pattern = ".*png")
    names(clusterplots) <- sub("\\.png$", "", basename(clusterplots))
  })
  data
}

# Given a named list of FASTA name/seq entries, make a grid of which sequences
# are represented in which FASTAs, with 0 for absent and 1 for present.
gather_seq_overlaps <- function(seq_sets) {
  seqs_all <- sort(unique(unlist(seq_sets)))
  mat <- do.call(cbind, lapply(names(seq_sets), function(samp) {
    seqs_all %in% seq_sets[[samp]]
  }))
  rownames(mat) <- seqs_all
  colnames(mat) <- names(seq_sets)
  as.data.frame(mat + 0)
}

# Load  a complete set of IgDiscover results with our output directory structure
# (chain_type/sample/...)
load_all_igdiscover_results <- function(dirpath) {
  igdiscover_results <- list()
  lapply(CHAINTYPES, function(chaintype) {
    dirs <- list.dirs(file.path(dirpath, chaintype), recursive=FALSE)
    names(dirs) <- basename(dirs)
    lapply(dirs, function(dirpath_inner) {
      load_igdiscover_final(dirpath_inner)
    })
  })
}

# Load the initial V/D/J used for each chain type for IgDiscover.
load_igdiscover_reference <- function(dirpath) {
  lapply(CHAINTYPES, function(chaintype) {
    lapply(SEGMENTS, function(segment) {
      dnar::read.fa(file.path(dirpath, chaintype, paste0(segment, ".fasta")))
    })
  })
}

igdiscover_results <- load_all_igdiscover_results(file.path(ROOT, "igdiscover"))
igdiscover_reference <- load_igdiscover_reference(file.path(ROOT, "igdiscover"))

overlaps <- list(
  mu = lapply(SEGMENTS, function(segment) {
    seq_sets <- lapply(igdiscover_results$mu, function(obj) obj$database[[segment]]$seq)
    seq_sets <- c(list(reference=igdiscover_reference$mu[[segment]]$seq), seq_sets)
    gather_seq_overlaps(seq_sets)
  }),
  kappa = lapply(SEGMENTS, function(segment) {
    seq_sets <- lapply(igdiscover_results$kappa, function(obj) obj$database[[segment]]$seq)
    seq_sets <- c(list(reference=igdiscover_reference$kappa[[segment]]$seq), seq_sets)
    gather_seq_overlaps(seq_sets)
  }),
  lambda = lapply(SEGMENTS, function(segment) {
    seq_sets <- lapply(igdiscover_results$lambda, function(obj) obj$database[[segment]]$seq)
    seq_sets <- c(list(reference=igdiscover_reference$lambda[[segment]]$seq), seq_sets)
    gather_seq_overlaps(seq_sets)
  })
)
```

## IgDiscover - Results Summary by Chain Type

The below plots summarize the number and overlap of alleles detected in each of 
the heavy (mu) chain samples compared with the starting reference database. 
Each horizontal bar shows the total number of sequences in that sample.  Each
vertical bar is a particular combination of samples, with height displaying the
number of sequences occuring in that combination.

### Heavy Chain - Mu - V Segment

```{r fig.height=4}
UpSetR::upset(overlaps$mu$V, order.by = "freq")
```

### Heavy Chain - Mu - D Segment

```{r fig.height=4}
UpSetR::upset(overlaps$mu$D, order.by = "freq")
```

### Heavy Chain - Mu - J Segment

```{r fig.height=4}
UpSetR::upset(overlaps$mu$J, order.by = "freq")
```

### Light Chain - Kappa - V Segment

```{r fig.height=4}
UpSetR::upset(overlaps$kappa$V, order.by = "freq")
```

### Light Chain - Kappa - J Segment

```{r fig.height=4}
UpSetR::upset(overlaps$kappa$J, order.by = "freq")
```

### Light Chain - Lambda - V Segment

```{r fig.height=4}
UpSetR::upset(overlaps$lambda$V, order.by = "freq")
```

### Light Chain - Lambda - J Segment

```{r fig.height=4}
UpSetR::upset(overlaps$lambda$J, order.by = "freq")
```

## IgDiscover - Results by Specimen

Below are read counts through each stage of IgDiscover filtering for each 
sample.  The input is as specified in the Grouping by Specimen section above. 
According to the paper around 400,000 input reads should be sufficient.

```{r}
abbrs <- c(
    Chain = "Chain", Type = "Type", Specimen = "Specimen",
    total = "total", has_vj_assignment = "has_vj", has_no_stop = "no_stop",
    good_v_evalue = "good_v_ev", good_v_coverage = "good_v_cov",
    good_j_coverage = "good_j_cov", has_cdr3 = "has_cdr3")

with(NULL, {
  cts <- do.call(
    rbind.data.frame,
    do.call(c, lapply(names(igdiscover_results), function(chain_type) {
    lapply(names(igdiscover_results[[chain_type]]), function(spec) {
      c(
        list(Type=chain_type, Specimen=spec),
        igdiscover_results[[chain_type]][[spec]]$stats$filtered)
    })
  })))
  colnames(cts) <- abbrs[colnames(cts)]
  kableExtra::kable_styling(drawtab(cts), font_size = 6)
})


```

### IgDiscover - Results by Specimen - Cluster Plots

These plots visualize the similarity of sequences assigned to a particular
output allele, grouped here by specimen by locus.  The full-size images are
available in the IgDiscover output files.

```{r results="asis"}
with(NULL, {
  specimens <- list()
  for (chain_type in names(igdiscover_results)) {
    for (spec in names(igdiscover_results[[chain_type]])) {
      specimens[[spec]][[chain_type]] <- igdiscover_results[[chain_type]][[spec]]$clusterplots
    }
  }
  for (spec in names(specimens)) {
    for (chain_type in names(specimens[[spec]])) {
     cat(paste0("\n\n#### ", spec, " - ", chain_type, "\n\n"))
      img <- file.path(sub("/igdiscover/", "/reporting/igdiscover/", igdiscover_results[[chain_type]][[spec]]$path), "clusterplots.png")
      if (file.exists(img)) {
        cat(paste0("![](", img, ")\n"))
      } else {
        cat("No clusterplot summary available for this specimen.")
      }
    }
  }
})
```

### IgDiscover - Results by Antibody Lineage

```{r}
# data frame of alleles per specimen/chain_type/segment
tabulate_specimen_alleles <- function(igdiscover_results, metadata) {
  do.call(rbind, lapply(names(igdiscover_results), function(chain_type) {
    do.call(rbind, lapply(names(igdiscover_results[[chain_type]]), function(spec) {
      do.call(rbind, lapply(names(igdiscover_results[[chain_type]][[spec]]$database), function(segment) {
        data.frame(
          Subject = metadata$specimens$Subject[match(spec, metadata$specimens$Specimen)],
          Specimen = spec,
          ChainType = chain_type,
          Segment = segment,
          Allele = igdiscover_results[[chain_type]][[spec]]$database[[segment]]$name,
          Seq = igdiscover_results[[chain_type]][[spec]]$database[[segment]]$seq,
          stringsAsFactors = FALSE)
      }))
    }))
  }))
}

specimen_alleles <- tabulate_specimen_alleles(igdiscover_results, metadata)
```

```{r}
# TODO show summary alignment of similar alleles for V(D)J for each lineage
subject <- "08N021"
heavy_lineage <- subset(metadata$antibody_lineages, Subject == subject)
heavy_isolates <- subset(metadata$antibody_isolates, AntibodyLineage == heavy_lineage$AntibodyLineage)
alleles <- subset(specimen_alleles, Subject == subject)
```